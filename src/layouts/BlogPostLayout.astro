---
import BaseLayout from './BaseLayout.astro';
import type { Locale } from '@i18n/utils';
import { t, getLocalePath } from '@i18n/utils';
import { formatDate } from '@lib/utils';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  tags: string[];
  readingTime: number;
  headings: { depth: number; slug: string; text: string }[];
  prevPost?: { title: string; slug: string };
  nextPost?: { title: string; slug: string };
  locale: Locale;
}

const {
  title,
  description,
  pubDate,
  updatedDate,
  tags,
  readingTime,
  headings,
  prevPost,
  nextPost,
  locale,
} = Astro.props;

const strings = t(locale);
const tocHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

<BaseLayout title={`${title} â€” ${strings.blog.title}`} description={description}>
  <article class="mx-auto max-w-5xl px-4 py-12 md:px-6 md:py-16">
    <!-- Header -->
    <header class="mx-auto mb-8 max-w-3xl" data-animate>
      <a
        href={getLocalePath('/blog', locale)}
        class="mb-6 inline-flex items-center text-sm text-text-secondary transition-colors hover:text-accent"
      >
        {strings.blog.backToBlog}
      </a>
      <h1 class="mb-4 text-3xl font-bold leading-tight text-text-primary md:text-4xl">
        {title}
      </h1>
      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-text-secondary">
        <time datetime={pubDate.toISOString()}>
          {formatDate(pubDate, locale)}
        </time>
        <span>&middot;</span>
        <span>{readingTime} {strings.blog.minRead}</span>
        {updatedDate && (
          <>
            <span>&middot;</span>
            <span>{strings.blog.updatedOn} {formatDate(updatedDate, locale)}</span>
          </>
        )}
      </div>
      {tags.length > 0 && (
        <div class="mt-4 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="rounded-full bg-accent/10 px-2.5 py-0.5 text-xs font-medium text-accent">
              {tag}
            </span>
          ))}
        </div>
      )}
    </header>

    <!-- Mobile ToC -->
    {tocHeadings.length > 0 && (
      <div class="mx-auto mb-8 max-w-3xl lg:hidden" data-mobile-toc>
        <button
          class="flex w-full items-center gap-2 rounded-lg border border-border px-4 py-3 text-sm font-semibold text-text-primary transition-colors hover:border-accent/30"
          data-toc-toggle
          aria-expanded="false"
        >
          <svg
            class="h-4 w-4 transition-transform duration-300"
            data-toc-chevron
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
              clip-rule="evenodd"
            />
          </svg>
          {strings.blog.tableOfContents}
        </button>
        <div class="toc-mobile" data-toc-content data-open="false">
          <div class="overflow-hidden">
            <ul class="space-y-2 px-4 pt-3 text-sm">
              {tocHeadings.map((heading) => (
                <li class={heading.depth === 3 ? 'ml-3' : ''}>
                  <a
                    href={`#${heading.slug}`}
                    class="text-text-secondary transition-colors hover:text-accent"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    )}

    <!-- Content + Desktop ToC -->
    <div class="mx-auto max-w-3xl lg:max-w-none lg:grid lg:grid-cols-[minmax(0,768px)_1fr] lg:gap-12">
      <!-- Main content -->
      <div class="prose" data-animate data-delay="100">
        <slot />
      </div>

      <!-- Desktop ToC sidebar -->
      {tocHeadings.length > 0 && (
        <aside class="hidden lg:block">
          <nav class="sticky top-24">
            <h2 class="mb-3 text-xs font-semibold uppercase tracking-wider text-text-secondary">
              {strings.blog.tableOfContents}
            </h2>
            <ul class="space-y-2 border-l border-border pl-4 text-sm">
              {tocHeadings.map((heading) => (
                <li class={heading.depth === 3 ? 'ml-3' : ''}>
                  <a
                    href={`#${heading.slug}`}
                    class="text-text-secondary transition-colors hover:text-accent"
                  >
                    {heading.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}
    </div>

    <!-- Prev/Next Navigation -->
    <div class="mx-auto max-w-3xl">
      {(prevPost || nextPost) && (
        <nav class="mt-12 flex flex-col gap-4 border-t border-border pt-8 sm:flex-row sm:justify-between">
          {prevPost ? (
            <a
              href={getLocalePath(`/blog/${prevPost.slug}`, locale)}
              class="group flex flex-col rounded-lg border border-border p-4 transition-all duration-300 hover:border-accent/30 hover:shadow-md hover:shadow-accent/5 sm:max-w-[48%]"
            >
              <span class="text-xs text-text-secondary">{strings.blog.prevPost}</span>
              <span class="mt-1 text-sm font-medium text-text-primary transition-colors group-hover:text-accent">
                {prevPost.title}
              </span>
            </a>
          ) : <div />}
          {nextPost ? (
            <a
              href={getLocalePath(`/blog/${nextPost.slug}`, locale)}
              class="group flex flex-col rounded-lg border border-border p-4 text-right transition-all duration-300 hover:border-accent/30 hover:shadow-md hover:shadow-accent/5 sm:ml-auto sm:max-w-[48%]"
            >
              <span class="text-xs text-text-secondary">{strings.blog.nextPost}</span>
              <span class="mt-1 text-sm font-medium text-text-primary transition-colors group-hover:text-accent">
                {nextPost.title}
              </span>
            </a>
          ) : <div />}
        </nav>
      )}

      <!-- Back to Blog -->
      <div class="mt-8 text-center">
        <a
          href={getLocalePath('/blog', locale)}
          class="text-sm text-text-secondary transition-colors hover:text-accent"
        >
          {strings.blog.backToBlog}
        </a>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .toc-mobile {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s ease-out;
  }
  .toc-mobile[data-open="true"] {
    grid-template-rows: 1fr;
  }
  [data-toc-toggle][aria-expanded="true"] [data-toc-chevron] {
    transform: rotate(90deg);
  }
</style>

<script>
  function setupMobileToc() {
    document.querySelectorAll('[data-mobile-toc]').forEach((toc) => {
      const toggle = toc.querySelector('[data-toc-toggle]');
      const content = toc.querySelector('[data-toc-content]');
      if (!toggle || !content) return;

      toggle.addEventListener('click', () => {
        const isOpen = content.getAttribute('data-open') === 'true';
        content.setAttribute('data-open', isOpen ? 'false' : 'true');
        toggle.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
      });
    });
  }

  setupMobileToc();
  document.addEventListener('astro:after-swap', setupMobileToc);
</script>

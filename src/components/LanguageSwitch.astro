---
import { getLocaleFromUrl, switchLocalePath, getLocalePath } from '@i18n/utils';
import { getCollection } from 'astro:content';

const locale = getLocaleFromUrl(Astro.url);
const targetLocale = locale === 'en' ? 'zh' : 'en';
const label = locale === 'en' ? '中文' : 'EN';

// Check if we're on a blog post page (e.g. /en/blog/some-slug)
const pathname = Astro.url.pathname;
const blogPostMatch = pathname.match(/^\/(en|zh)\/blog\/(.+?)\/?$/);

let targetPath: string;

if (blogPostMatch) {
  const slug = blogPostMatch[2];
  // Check if the translated blog post exists
  const allPosts = await getCollection('blog');
  const translationExists = allPosts.some(
    (entry) => entry.id.startsWith(`${targetLocale}/`) &&
      entry.id.replace(`${targetLocale}/`, '').replace(/\.(md|mdx)$/, '') === slug
  );
  targetPath = translationExists
    ? getLocalePath(`/blog/${slug}`, targetLocale)
    : getLocalePath('/blog', targetLocale);
} else {
  targetPath = switchLocalePath(pathname, targetLocale);
}
---

<a
  href={targetPath}
  class="flex h-9 items-center rounded-lg px-2.5 text-sm font-medium text-text-secondary transition-colors hover:bg-bg-secondary hover:text-text-primary"
  aria-label={`Switch to ${targetLocale === 'en' ? 'English' : 'Chinese'}`}
>
  {label}
</a>

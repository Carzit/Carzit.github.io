---
import type { Locale } from '@i18n/utils';
import { t } from '@i18n/utils';

type LinkType = 'pdf' | 'arxiv' | 'code' | 'doi' | 'data' | 'slides' | 'poster' | 'video' | 'demo';

interface Props {
  title: string;
  authors: string[];
  venue: string;
  year: number;
  status: 'published' | 'accepted' | 'revision' | 'under-review' | 'preprint' | 'working-paper';
  links: { type: LinkType; url: string }[];
  locale: Locale;
}

const { title, authors, venue, year, status, links, locale } = Astro.props;
const strings = t(locale);

const statusStyles: Record<string, { label: string; classes: string }> = {
  'published': {
    label: strings.research.published,
    classes: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400',
  },
  'accepted': {
    label: strings.research.accepted,
    classes: 'bg-teal-100 text-teal-700 dark:bg-teal-500/20 dark:text-teal-400',
  },
  'revision': {
    label: strings.research.revision,
    classes: 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400',
  },
  'under-review': {
    label: strings.research.underReview,
    classes: 'bg-orange-100 text-orange-700 dark:bg-orange-500/20 dark:text-orange-400',
  },
  'preprint': {
    label: strings.research.preprint,
    classes: 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-400',
  },
  'working-paper': {
    label: strings.research.workingPaper,
    classes: 'bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-400',
  },
};

// Icon SVG paths keyed by link type
const linkMeta: Record<LinkType, { label: string; icon?: string }> = {
  pdf: {
    label: 'PDF',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />',
  },
  arxiv: { label: 'arXiv' },
  code: {
    label: 'Code',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />',
  },
  doi: { label: 'DOI' },
  data: {
    label: 'Data',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />',
  },
  slides: {
    label: 'Slides',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h16.5M3.75 3l2.664 11.986M20.25 3v11.25A2.25 2.25 0 0118 16.5h-2.25M20.25 3l-2.664 11.986m0 0l-1.836 6.514m-8.25-6.514l1.836 6.514m-1.836-6.514h8.25" />',
  },
  poster: {
    label: 'Poster',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 002.25-2.25V5.25a2.25 2.25 0 00-2.25-2.25H3.75a2.25 2.25 0 00-2.25 2.25v13.5a2.25 2.25 0 002.25 2.25z" />',
  },
  video: {
    label: 'Video',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 010 1.972l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" />',
  },
  demo: {
    label: 'Demo',
    icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />',
  },
};

const { label: statusLabel, classes: statusClasses } = statusStyles[status];
const HIGHLIGHT_NAME = 'Zitong Cheng';
---

<article
  class="rounded-xl border border-border p-5 transition-all duration-300 hover:-translate-y-0.5 hover:border-accent/30 hover:shadow-lg hover:shadow-accent/5"
  data-publication-card
>
  <!-- Title + Status Badge -->
  <div class="mb-3 flex flex-wrap items-start justify-between gap-x-4 gap-y-2">
    <h3 class="min-w-0 flex-1 text-lg font-semibold leading-snug text-text-primary">
      {title}
    </h3>
    <span class={`shrink-0 rounded-full px-2.5 py-0.5 text-xs font-medium ${statusClasses}`}>
      {statusLabel}
    </span>
  </div>

  <!-- Authors -->
  <p class="mb-1 text-sm text-text-secondary">
    {authors.map((author, i) => (
      <>
        {i > 0 && ', '}
        {author === HIGHLIGHT_NAME
          ? <strong class="font-semibold text-text-primary">{author}</strong>
          : <span>{author}</span>
        }
      </>
    ))}
  </p>

  <!-- Venue + Year -->
  <p class="mb-4 text-sm text-text-secondary">
    <span class="italic">{venue}</span>
    <span class="mx-1.5">&middot;</span>
    <span>{year}</span>
  </p>

  <!-- Action Links -->
  {links.length > 0 && (
    <div class="mb-3 flex flex-wrap items-center gap-2">
      {links.map((link) => {
        const meta = linkMeta[link.type];
        const href = link.type === 'doi' ? `https://doi.org/${link.url}` : link.url;
        return (
          <a
            href={href}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 rounded-md border border-border px-2.5 py-1 text-xs font-medium text-text-secondary transition-colors hover:border-accent hover:text-accent"
          >
            {meta.icon && (
              <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <Fragment set:html={meta.icon} />
              </svg>
            )}
            {meta.label}
          </a>
        );
      })}
    </div>
  )}

  <!-- Abstract Toggle -->
  <button
    class="inline-flex items-center gap-1.5 text-sm text-text-secondary transition-colors hover:text-accent"
    data-abstract-toggle
    aria-expanded="false"
  >
    <svg
      class="h-3.5 w-3.5 transition-transform duration-300"
      data-chevron
      viewBox="0 0 20 20"
      fill="currentColor"
    >
      <path
        fill-rule="evenodd"
        d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
        clip-rule="evenodd"
      />
    </svg>
    {strings.research.abstract}
  </button>

  <!-- Abstract Content (animated) -->
  <div class="pub-abstract" data-abstract-content data-open="false">
    <div class="overflow-hidden">
      <div class="pt-3 text-sm leading-relaxed text-text-secondary">
        <slot />
      </div>
    </div>
  </div>
</article>

<style>
  .pub-abstract {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s ease-out;
  }
  .pub-abstract[data-open="true"] {
    grid-template-rows: 1fr;
  }
  [data-abstract-toggle][aria-expanded="true"] [data-chevron] {
    transform: rotate(90deg);
  }
</style>

<script>
  function setupPublicationCards() {
    document.querySelectorAll('[data-publication-card]').forEach((card) => {
      const toggle = card.querySelector('[data-abstract-toggle]');
      const content = card.querySelector('[data-abstract-content]');
      if (!toggle || !content) return;

      toggle.addEventListener('click', () => {
        const isOpen = content.getAttribute('data-open') === 'true';
        content.setAttribute('data-open', isOpen ? 'false' : 'true');
        toggle.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
      });
    });
  }

  setupPublicationCards();
  document.addEventListener('astro:after-swap', setupPublicationCards);
</script>

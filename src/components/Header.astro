---
import { getLocaleFromUrl, t, getLocalePath } from '@i18n/utils';
import { NAV_ITEMS, SITE } from '@lib/constants';
import ThemeToggle from './ThemeToggle.astro';
import LanguageSwitch from './LanguageSwitch.astro';

const locale = getLocaleFromUrl(Astro.url);
const strings = t(locale);
const currentPath = Astro.url.pathname;
---

<header
  id="site-header"
  class="sticky top-0 z-50 w-full border-b"
  transition:animate="none"
>
  <nav class="mx-auto flex h-16 max-w-4xl items-center justify-between px-4 md:px-6">
    <a
      href={getLocalePath('/', locale)}
      class="text-lg font-semibold text-text-primary transition-colors hover:text-accent"
    >
      {SITE.title}
    </a>

    <!-- Desktop nav -->
    <div class="hidden items-center gap-1 md:flex">
      {NAV_ITEMS.map((item) => {
        const href = getLocalePath(item.path, locale);
        const isActive = currentPath === href || (item.path !== '/' && currentPath.startsWith(href));
        return (
          <a
            href={href}
            class:list={[
              'link-underline rounded-lg px-3 py-2 text-sm font-medium transition-colors',
              isActive
                ? 'text-accent'
                : 'text-text-secondary hover:text-text-primary',
            ]}
          >
            {strings.nav[item.key]}
          </a>
        );
      })}
      <div class="ml-2 flex items-center gap-1 border-l border-border pl-2">
        <LanguageSwitch />
        <ThemeToggle />
      </div>
    </div>

    <!-- Mobile menu button -->
    <div class="flex items-center gap-1 md:hidden">
      <LanguageSwitch />
      <ThemeToggle />
      <button
        id="mobile-menu-btn"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        class="flex h-9 w-9 items-center justify-center rounded-lg text-text-secondary transition-colors hover:bg-bg-secondary hover:text-text-primary"
      >
        <svg class="hamburger-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg class="close-icon hidden h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </nav>

  <!-- Mobile menu (slide animation) -->
  <div id="mobile-menu" class="mobile-menu-inner border-t border-border md:hidden">
    <div class="overflow-hidden">
      <div class="mx-auto max-w-4xl space-y-1 px-4 py-3">
        {NAV_ITEMS.map((item) => {
          const href = getLocalePath(item.path, locale);
          const isActive = currentPath === href || (item.path !== '/' && currentPath.startsWith(href));
          return (
            <a
              href={href}
              class:list={[
                'block rounded-lg px-3 py-2 text-sm font-medium transition-colors',
                isActive
                  ? 'text-accent bg-bg-secondary'
                  : 'text-text-secondary hover:bg-bg-secondary hover:text-text-primary',
              ]}
            >
              {strings.nav[item.key]}
            </a>
          );
        })}
      </div>
    </div>
  </div>
</header>

<script>
  function setupMobileMenu() {
    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    if (!btn || !menu) return;

    const hamburger = btn.querySelector('.hamburger-icon') as HTMLElement;
    const close = btn.querySelector('.close-icon') as HTMLElement;

    // Reset state
    menu.classList.remove('is-open');
    hamburger.classList.remove('hidden');
    close.classList.add('hidden');
    btn.setAttribute('aria-expanded', 'false');

    btn.addEventListener('click', () => {
      const isOpen = menu.classList.contains('is-open');
      menu.classList.toggle('is-open');
      hamburger.classList.toggle('hidden');
      close.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!isOpen));
    });
  }

  setupMobileMenu();
  document.addEventListener('astro:after-swap', setupMobileMenu);
</script>

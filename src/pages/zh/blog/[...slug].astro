---
import BlogPostLayout from '@layouts/BlogPostLayout.astro';
import { getCollection, render } from 'astro:content';
import { getReadingTime } from '@lib/utils';

const locale = 'zh';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const posts = allPosts
    .filter((entry) => entry.id.startsWith('zh/'))
    .filter((entry) => !entry.data.draft)
    .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

  return posts.map((entry, index) => {
    const slug = entry.id.replace('zh/', '').replace(/\.(md|mdx)$/, '');
    const prevEntry = index < posts.length - 1 ? posts[index + 1] : null;
    const nextEntry = index > 0 ? posts[index - 1] : null;

    return {
      params: { slug },
      props: {
        entry,
        prevPost: prevEntry ? {
          title: prevEntry.data.title,
          slug: prevEntry.id.replace('zh/', '').replace(/\.(md|mdx)$/, ''),
        } : undefined,
        nextPost: nextEntry ? {
          title: nextEntry.data.title,
          slug: nextEntry.id.replace('zh/', '').replace(/\.(md|mdx)$/, ''),
        } : undefined,
      },
    };
  });
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(entry);
const readingTime = getReadingTime(entry.body ?? '');
---

<BlogPostLayout
  title={entry.data.title}
  description={entry.data.description}
  pubDate={entry.data.pubDate}
  updatedDate={entry.data.updatedDate}
  tags={entry.data.tags}
  readingTime={readingTime}
  headings={headings}
  prevPost={prevPost}
  nextPost={nextPost}
  locale={locale}
>
  <Content />
</BlogPostLayout>
